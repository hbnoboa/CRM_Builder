# PowerSync configuration for CRM Builder
# This file configures the self-hosted PowerSync service
# to sync data from PostgreSQL to Flutter mobile devices.
#
# Schema ref: https://unpkg.com/@powersync/service-schema@latest/json-schema/powersync-config.json

# PostgreSQL logical replication connection
replication:
  connections:
    - type: postgresql
      uri: !env PS_REPLICATION_URI
      sslmode: disable

# Admin API tokens (for health checks, diagnostics)
api:
  tokens:
    - !env PS_API_TOKEN

# Client authentication (validates Flutter app JWTs using HS256)
# JWT claims: sub (user id), tenantId, email, customRoleId, roleType
client_auth:
  audience: ["powersync"]
  jwks:
    keys:
      - kty: oct
        alg: HS256
        k: !env PS_JWT_SECRET_B64

# Storage backend for PowerSync internal state (MongoDB required by v1.19+)
storage:
  type: mongodb
  uri: !env PS_MONGO_URI

# Sync rules: define which data each user can access
# JWT payload: { sub: "userId", tenantId: "tenantId", ... }
sync_rules:
  content: |
    bucket_definitions:
      # Tenant-scoped data (entities, records, roles)
      tenant_data:
        parameters: SELECT request.jwt() ->> 'tenantId' as tenant_id
        data:
          # Entity definitions (schema)
          - SELECT id, "tenantId", name, "namePlural", slug, description, icon, color, fields, settings, "isSystem", "createdAt", "updatedAt"
            FROM "Entity"
            WHERE "tenantId" = bucket.tenant_id

          # Entity data records (exclude soft-deleted)
          - SELECT id, "tenantId", "entityId", data, "parentRecordId", "createdById", "updatedById", "createdAt", "updatedAt"
            FROM "EntityData"
            WHERE "tenantId" = bucket.tenant_id AND "deletedAt" IS NULL

          # Custom roles (for permission checks)
          - SELECT id, "tenantId", name, description, color, "roleType", "isSystem", permissions, "modulePermissions", "tenantPermissions", "isDefault", "createdAt", "updatedAt"
            FROM "CustomRole"
            WHERE "tenantId" = bucket.tenant_id

      # User-specific data
      user_data:
        parameters: SELECT request.user_id() as user_id, request.jwt() ->> 'tenantId' as tenant_id
        data:
          # Current user profile
          - SELECT id, "tenantId", email, name, avatar, "customRoleId", status, "createdAt"
            FROM "User"
            WHERE id = bucket.user_id AND "tenantId" = bucket.tenant_id

          # User's notifications
          - SELECT id, "tenantId", "userId", type, title, message, data, "entitySlug", read, "readAt", "createdAt"
            FROM "Notification"
            WHERE "userId" = bucket.user_id AND "tenantId" = bucket.tenant_id
