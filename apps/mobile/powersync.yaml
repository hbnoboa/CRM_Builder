# PowerSync configuration for CRM Builder
# This file configures the self-hosted PowerSync service
# to sync data from PostgreSQL to Flutter mobile devices.
#
# Schema ref: https://unpkg.com/@powersync/service-schema@latest/json-schema/powersync-config.json

# PostgreSQL logical replication connection
replication:
  connections:
    - type: postgresql
      uri: !env PS_REPLICATION_URI
      sslmode: disable

# Admin API tokens (for health checks, diagnostics)
api:
  tokens:
    - !env PS_API_TOKEN

# Client authentication (validates Flutter app JWTs using HS256)
# JWT claims: sub (user id), tenantId, email, customRoleId, roleType
client_auth:
  audience: ["powersync"]
  jwks:
    keys:
      - kty: oct
        alg: HS256
        k: !env PS_JWT_SECRET_B64

# Storage backend for PowerSync internal state (MongoDB required by v1.19+)
storage:
  type: mongodb
  uri: !env PS_MONGO_URI

# Sync rules: define which data each user can access
# JWT payload: { sub: "userId", tenantId: "tenantId", customRoleId: "...", roleType: "..." }
#
# PowerSync supported SQL: =, !=, <, >, AND, OR, NOT, IS NULL, IS NOT NULL
# PowerSync IN operator: works with JSONB arrays (bucket.param IN json_column)
# No JOINs, no GROUP BY, no ORDER BY, no LIMIT, no subqueries
# Each data query must reference ALL bucket parameters
#
# Strategy: Two EntityData buckets for role-based filtering:
# 1. unrestricted_entity_data: records with no role filters (_hasRoleFilter=false)
# 2. role_filtered_entity_data: records filtered by role (_hasRoleFilter=true)
#    Uses PowerSync IN operator: bucket.role_id IN "_visibleToRolesJson"
sync_rules:
  content: |
    bucket_definitions:
      # Bucket 1: user-specific data (requires user_id + tenant_id)
      user_data:
        parameters: |
          SELECT
            request.user_id() as user_id,
            request.jwt() ->> 'tenantId' as tenant_id
        data:
          # Current user profile
          - SELECT id, "tenantId", email, name, avatar, "customRoleId", status, "createdAt"
            FROM "User"
            WHERE id = bucket.user_id AND "tenantId" = bucket.tenant_id

          # User's notifications
          - SELECT id, "tenantId", "userId", type, title, message, data, "entitySlug", read, "readAt", "createdAt"
            FROM "Notification"
            WHERE "userId" = bucket.user_id AND "tenantId" = bucket.tenant_id

      # Bucket 2: tenant-level shared data (roles, entities)
      # All users in the same tenant see the same metadata.
      tenant_data:
        parameters: |
          SELECT
            request.jwt() ->> 'tenantId' as tenant_id
        data:
          # Custom roles (for client-side permission checks)
          - SELECT id, "tenantId", name, description, color, "roleType", "isSystem", permissions, "modulePermissions", "tenantPermissions", "isDefault", "createdAt", "updatedAt"
            FROM "CustomRole"
            WHERE "tenantId" = bucket.tenant_id

          # All entity definitions for tenant
          - SELECT id, "tenantId", name, "namePlural", slug, description, icon, color, fields, settings, "isSystem", "createdAt", "updatedAt"
            FROM "Entity"
            WHERE "tenantId" = bucket.tenant_id

      # Bucket 3: entity data WITHOUT role filters (all tenant users see these)
      # _hasRoleFilter = false means no role has data filters for this entity
      unrestricted_entity_data:
        parameters: |
          SELECT
            request.jwt() ->> 'tenantId' as tenant_id
        data:
          - SELECT id, "tenantId", "entityId", data, "parentRecordId", "createdById", "updatedById", "createdAt", "updatedAt", "deletedAt"
            FROM "EntityData"
            WHERE "tenantId" = bucket.tenant_id
              AND "deletedAt" IS NULL
              AND "_matchesGlobalFilter" = true
              AND "_parentMatchesFilter" = true
              AND "_hasRoleFilter" = false

      # Bucket 4: entity data WITH role filters (only matching roles see these)
      # Uses PowerSync IN operator on JSONB array column
      # bucket.role_id comes from JWT customRoleId claim
      # _visibleToRolesJson is a JSONB array like ["role-id-1", "role-id-2"]
      # ADMIN/PLATFORM_ADMIN role IDs are NOT in _visibleToRolesJson because
      # _hasRoleFilter=false for entities with no filters. When filters exist,
      # ADMIN/PLATFORM_ADMIN see records via this bucket (their roleId is in the array).
      role_filtered_entity_data:
        parameters: |
          SELECT
            request.jwt() ->> 'tenantId' as tenant_id,
            request.jwt() ->> 'customRoleId' as role_id
        data:
          - SELECT id, "tenantId", "entityId", data, "parentRecordId", "createdById", "updatedById", "createdAt", "updatedAt", "deletedAt"
            FROM "EntityData"
            WHERE "tenantId" = bucket.tenant_id
              AND "deletedAt" IS NULL
              AND "_matchesGlobalFilter" = true
              AND "_parentMatchesFilter" = true
              AND "_hasRoleFilter" = true
              AND bucket.role_id IN "_visibleToRolesJson"
