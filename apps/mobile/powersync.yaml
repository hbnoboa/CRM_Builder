# PowerSync configuration for CRM Builder
# This file configures the self-hosted PowerSync service
# to sync data from PostgreSQL to Flutter mobile devices.
#
# Schema ref: https://unpkg.com/@powersync/service-schema@latest/json-schema/powersync-config.json

# PostgreSQL logical replication connection
replication:
  connections:
    - type: postgresql
      uri: !env PS_REPLICATION_URI
      sslmode: disable

# Admin API tokens (for health checks, diagnostics)
api:
  tokens:
    - !env PS_API_TOKEN

# Client authentication (validates Flutter app JWTs using HS256)
# JWT claims: sub (user id), tenantId, email, customRoleId, roleType
client_auth:
  audience: ["powersync"]
  jwks:
    keys:
      - kty: oct
        alg: HS256
        k: !env PS_JWT_SECRET_B64

# Storage backend for PowerSync internal state (MongoDB required by v1.19+)
storage:
  type: mongodb
  uri: !env PS_MONGO_URI

# Sync rules: define which data each user can access
# JWT payload: { sub: "userId", tenantId: "tenantId", customRoleId: "...", roleType: "..." }
#
# PowerSync limitations:
# - No JOINs, no custom PG functions, no CASTs
# - Each data query must reference ALL bucket parameters
# So we split into 2 buckets and do permission/filter logic client-side
sync_rules:
  content: |
    bucket_definitions:
      # Bucket 1: user-specific data (requires user_id + tenant_id)
      user_data:
        parameters: |
          SELECT
            request.user_id() as user_id,
            request.jwt() ->> 'tenantId' as tenant_id
        data:
          # Current user profile
          - SELECT id, "tenantId", email, name, avatar, "customRoleId", status, "createdAt"
            FROM "User"
            WHERE id = bucket.user_id AND "tenantId" = bucket.tenant_id

          # User's notifications
          - SELECT id, "tenantId", "userId", type, title, message, data, "entitySlug", read, "readAt", "createdAt"
            FROM "Notification"
            WHERE "userId" = bucket.user_id AND "tenantId" = bucket.tenant_id

      # Bucket 2: tenant-level data for ADMINS (all data)
      admin_data:
        parameters: |
          SELECT
            request.jwt() ->> 'tenantId' as tenant_id,
            request.jwt() ->> 'roleType' as role_type
          WHERE request.jwt() ->> 'roleType' IN ('PLATFORM_ADMIN', 'ADMIN')
        data:
          # Custom roles (for client-side permission checks)
          - SELECT id, "tenantId", name, description, color, "roleType", "isSystem", permissions, "modulePermissions", "tenantPermissions", "dataFilters", "isDefault", "createdAt", "updatedAt"
            FROM "CustomRole"
            WHERE "tenantId" = bucket.tenant_id

          # All entity definitions for tenant
          - SELECT id, "tenantId", name, "namePlural", slug, description, icon, color, fields, settings, "isSystem", "createdAt", "updatedAt"
            FROM "Entity"
            WHERE "tenantId" = bucket.tenant_id

          # All entity data (admins see everything)
          - SELECT id, "tenantId", "entityId", data, "parentRecordId", "createdById", "updatedById", "createdAt", "updatedAt", "deletedAt"
            FROM "EntityData"
            WHERE "tenantId" = bucket.tenant_id
              AND "deletedAt" IS NULL
              AND "_matchesGlobalFilter" = true
              AND "_parentMatchesFilter" = true

      # Bucket 3: tenant-level data for non-admin roles (filtered by role)
      role_filtered_data:
        parameters: |
          SELECT
            request.jwt() ->> 'tenantId' as tenant_id,
            request.jwt() ->> 'customRoleId' as custom_role_id,
            request.jwt() ->> 'roleType' as role_type
          WHERE request.jwt() ->> 'roleType' NOT IN ('PLATFORM_ADMIN', 'ADMIN')
        data:
          # Custom roles (for client-side permission checks)
          - SELECT id, "tenantId", name, description, color, "roleType", "isSystem", permissions, "modulePermissions", "tenantPermissions", "dataFilters", "isDefault", "createdAt", "updatedAt"
            FROM "CustomRole"
            WHERE "tenantId" = bucket.tenant_id

          # All entity definitions for tenant
          - SELECT id, "tenantId", name, "namePlural", slug, description, icon, color, fields, settings, "isSystem", "createdAt", "updatedAt"
            FROM "Entity"
            WHERE "tenantId" = bucket.tenant_id

          # Entity data filtered by role
          # - _matchesGlobalFilter: record passes entity's global filters
          # - _parentMatchesFilter: parent record also passes (for sub-entities)
          # - _visibleToRoles: NULL means all can see, otherwise role must be in array
          - SELECT id, "tenantId", "entityId", data, "parentRecordId", "createdById", "updatedById", "createdAt", "updatedAt", "deletedAt"
            FROM "EntityData"
            WHERE "tenantId" = bucket.tenant_id
              AND "deletedAt" IS NULL
              AND "_matchesGlobalFilter" = true
              AND "_parentMatchesFilter" = true
              AND ("_visibleToRoles" IS NULL OR bucket.custom_role_id = ANY("_visibleToRoles"))
