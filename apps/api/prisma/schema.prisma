// CRM BUILDER - Database Schema
// PostgreSQL 16 + Prisma 5.x

generator client {
  provider = "prisma-client-js"
  // Enable previewFeatures if needed
  // previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Direct URL for migrations (bypasses connection pooler)
  // Uncomment if using PgBouncer or similar
  // directUrl = env("DIRECT_DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum Plan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum Status {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum UserRole {
  PLATFORM_ADMIN // Super admin da plataforma
  ADMIN          // Admin do tenant
  MANAGER        // Gerente (edita equipe)
  USER           // Usuário padrão (edita próprios)
  VIEWER         // Apenas visualização
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
}

enum AuthType {
  NONE
  JWT
  API_KEY
}

// ═══════════════════════════════════════════════════════════════════════════
// MULTI-TENANCY - NÍVEL 1: TENANT
// ═══════════════════════════════════════════════════════════════════════════

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  domain    String?  @unique
  logo      String?
  settings  Json     @default("{}")
  
  plan      Plan     @default(FREE)
  status    Status   @default(ACTIVE)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  organizations Organization[]
  users         User[]
  roles         Role[]
  
  @@index([slug])
  @@index([status])
  @@index([plan])
}

// ═══════════════════════════════════════════════════════════════════════════
// MULTI-TENANCY - NÍVEL 2: ORGANIZATION (Area de Trabalho)
// ═══════════════════════════════════════════════════════════════════════════

model Organization {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  slug      String
  settings  Json     @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users     User[]
  entities  Entity[]
  pages     Page[]
  endpoints CustomEndpoint[]

  @@unique([tenantId, slug])
  @@index([tenantId])
}

// ═══════════════════════════════════════════════════════════════════════════
// USERS
// ═══════════════════════════════════════════════════════════════════════════

model User {
  id             String    @id @default(cuid())
  tenantId       String
  organizationId String?

  email          String
  password       String
  name           String
  avatar         String?

  role           UserRole  @default(USER)
  status         Status    @default(ACTIVE)

  lastLoginAt         DateTime?
  resetToken          String?
  resetTokenExpires   DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relacionamentos
  tenant         Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id])
  userRoles      UserRole_[]   // Roles adicionais
  refreshTokens  RefreshToken[]

  // Dados criados por este usuário
  createdData    EntityData[]  @relation("CreatedBy")
  updatedData    EntityData[]  @relation("UpdatedBy")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([organizationId])
  @@index([email])
  @@index([status])
  // Composite indexes for common query patterns
  @@index([tenantId, status])
  @@index([tenantId, role])
  @@index([tenantId, organizationId])
  @@index([tenantId, createdAt(sort: Desc)])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
}

// ═══════════════════════════════════════════════════════════════════════════
// ROLES & PERMISSIONS (RBAC)
// ═══════════════════════════════════════════════════════════════════════════

model Role {
  id          String   @id @default(cuid())
  tenantId    String
  
  name        String
  slug        String
  description String?
  
  // Array de permissões: ["data:read:all", "cliente:update:own"]
  permissions Json     @default("[]")
  
  isSystem    Boolean  @default(false) // Roles do sistema não podem ser deletadas
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos
  tenant Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users  UserRole_[]
  
  @@unique([tenantId, slug])
  @@index([tenantId])
}

// Tabela pivô para roles adicionais do usuário
model UserRole_ {
  id     String @id @default(cuid())
  userId String
  roleId String
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// ═══════════════════════════════════════════════════════════════════════════
// ENTITY BUILDER (Entidades Dinâmicas)
// ═══════════════════════════════════════════════════════════════════════════

model Entity {
  id             String   @id @default(cuid())
  tenantId       String
  organizationId String

  name        String   // "Cliente"
  namePlural  String   // "Clientes"
  slug        String   // "cliente"
  description String?
  icon        String?  // "users"
  color       String?  // "#3B82F6"

  // Definicao dos campos (JSON Array)
  fields      Json     // [{ slug, name, type, required, options, ... }]

  // Configuracoes da entidade
  settings    Json     @default("{}")
  // {
  //   titleField: "nome",
  //   subtitleField: "email",
  //   searchFields: ["nome", "email"],
  //   defaultSort: { field: "createdAt", order: "desc" }
  // }

  isSystem    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  data            EntityData[]
  customEndpoints CustomEndpoint[] // APIs que usam esta entidade como fonte

  @@unique([organizationId, slug])
  @@index([tenantId])
  @@index([organizationId])
  // Composite indexes for common query patterns
  @@index([tenantId, organizationId])
  @@index([organizationId, name])
}

// ═══════════════════════════════════════════════════════════════════════════
// ENTITY DATA (Dados das Entidades)
// ═══════════════════════════════════════════════════════════════════════════

model EntityData {
  id        String   @id @default(cuid())
  tenantId  String
  entityId  String

  // Dados dinâmicos (JSON)
  data      Json     // { nome: "João", email: "joao@email.com", ... }

  // Auditoria
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?
  updatedById String?

  // Relacionamentos
  entity    Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  createdBy User?  @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy User?  @relation("UpdatedBy", fields: [updatedById], references: [id])

  @@index([tenantId])
  @@index([entityId])
  @@index([createdAt])
  @@index([createdById])
  // Composite indexes for common query patterns
  @@index([tenantId, entityId])
  @@index([tenantId, entityId, createdAt(sort: Desc)])
  @@index([entityId, createdAt(sort: Desc)])
  @@index([entityId, createdById])
}

// ═══════════════════════════════════════════════════════════════════════════
// PAGE BUILDER (Páginas Puck)
// ═══════════════════════════════════════════════════════════════════════════

model Page {
  id             String   @id @default(cuid())
  tenantId       String
  organizationId String

  title       String
  slug        String
  description String?
  icon        String?

  // Conteudo Puck (JSON)
  content     Json     @default("{}")

  // Status de publicacao
  isPublished Boolean  @default(false)
  publishedAt DateTime?

  // Permissoes necessarias para acessar
  permissions Json     @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, slug])
  @@index([tenantId])
  @@index([organizationId])
  @@index([isPublished])
  // Composite indexes for common query patterns
  @@index([tenantId, organizationId])
  @@index([organizationId, isPublished])
  @@index([tenantId, isPublished])
}

// ═══════════════════════════════════════════════════════════════════════════
// API BUILDER (Endpoints Customizados)
// ═══════════════════════════════════════════════════════════════════════════

model CustomEndpoint {
  id             String     @id @default(cuid())
  tenantId       String
  organizationId String

  name        String     // "Relatorio de Vendas"
  description String?
  path        String     // "relatorio-vendas"
  method      HttpMethod @default(POST)

  // Modo: visual (construtor) ou code (JavaScript)
  mode        String     @default("visual") // "visual" | "code"

  // Schemas de validacao
  requestSchema  Json?   // JSON Schema para request
  responseSchema Json?   // JSON Schema para response

  // ═══════════════════════════════════════════════════════════════════════════
  // MODO VISUAL - Configuracao sem codigo
  // ═══════════════════════════════════════════════════════════════════════════

  // Entidade fonte dos dados
  sourceEntityId String?
  sourceEntity   Entity?  @relation(fields: [sourceEntityId], references: [id], onDelete: SetNull)

  // Campos a retornar (array de nomes de campos)
  // Ex: ["nome", "email", "status"]
  selectedFields Json     @default("[]")

  // Filtros fixos (sempre aplicados)
  // Ex: [{ field: "status", operator: "equals", value: "ativo" }]
  filters        Json     @default("[]")

  // Parametros dinamicos da URL (query params)
  // Ex: [{ field: "cidade", operator: "equals", paramName: "cidade" }]
  queryParams    Json     @default("[]")

  // Ordenacao
  // Ex: { field: "createdAt", direction: "desc" }
  orderBy        Json?

  // Limite de registros
  limitRecords   Int?

  // ═══════════════════════════════════════════════════════════════════════════
  // MODO CODE - JavaScript customizado (avancado)
  // ═══════════════════════════════════════════════════════════════════════════

  // Logica em JavaScript (apenas para mode="code")
  logic       Json       @default("[]")

  // Seguranca
  auth        AuthType   @default(JWT)
  permissions Json       @default("[]") // Roles que podem acessar
  rateLimit   Int        @default(100)  // Requests por minuto

  // Status
  isActive    Boolean    @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, path, method])
  @@index([tenantId])
  @@index([organizationId])
  @@index([isActive])
  @@index([sourceEntityId])
  // Composite indexes for common query patterns
  @@index([tenantId, organizationId])
  @@index([organizationId, isActive])
}

// ═══════════════════════════════════════════════════════════════════════════
// AUDIT LOG
// ═══════════════════════════════════════════════════════════════════════════

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String?

  action    String   // "create", "update", "delete", "login", etc
  resource  String   // "user", "entity", "data", etc
  resourceId String?

  oldData   Json?
  newData   Json?
  metadata  Json?    // IP, User-Agent, etc

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  // Composite indexes for common query patterns
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, action])
  @@index([tenantId, resource])
  @@index([tenantId, userId])
  @@index([resource, resourceId])
}

// ═══════════════════════════════════════════════════════════════════════════
// NOTIFICATIONS
// ═══════════════════════════════════════════════════════════════════════════

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

model Notification {
  id        String           @id @default(cuid())
  tenantId  String
  userId    String

  type      NotificationType @default(INFO)
  title     String
  message   String
  data      Json?            // Additional data related to the notification

  read      Boolean          @default(false)
  readAt    DateTime?

  createdAt DateTime         @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([read])
  @@index([createdAt])
  // Composite indexes for common query patterns
  @@index([userId, read])
  @@index([userId, createdAt(sort: Desc)])
  @@index([tenantId, userId])
}
