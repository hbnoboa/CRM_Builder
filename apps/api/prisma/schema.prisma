// CRM BUILDER - Database Schema
// PostgreSQL 16 + Prisma 5.x

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum Status {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// UserRole enum REMOVIDO - agora usamos CustomRole.roleType
// Tipos validos: PLATFORM_ADMIN, ADMIN, MANAGER, USER, VIEWER, CUSTOM

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
}

enum AuthType {
  NONE
  JWT
  API_KEY
}

// ═══════════════════════════════════════════════════════════════════════════
// PDF TEMPLATES - Enums
// ═══════════════════════════════════════════════════════════════════════════

enum PdfPageSize {
  A4
  LETTER
  LEGAL
}

enum PdfOrientation {
  PORTRAIT
  LANDSCAPE
}

enum PdfGenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ═══════════════════════════════════════════════════════════════════════════
// TENANT (Empresa)
// ═══════════════════════════════════════════════════════════════════════════

model Tenant {
  id       String  @id @default(cuid())
  name     String
  slug     String  @unique
  domain   String? @unique
  logo     String?
  settings Json    @default("{}")

  status Status @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  users           User[]
  entities        Entity[]
  entityData      EntityData[]
  pages           Page[]
  customEndpoints CustomEndpoint[]
  customRoles     CustomRole[]
  notifications   Notification[]
  pdfTemplates    PdfTemplate[]
  pdfGenerations  PdfGeneration[]
  userTenantAccess UserTenantAccess[]

  @@index([slug])
  @@index([status])
}

// ═══════════════════════════════════════════════════════════════════════════
// USERS
// ═══════════════════════════════════════════════════════════════════════════

model User {
  id       String @id @default(cuid())
  tenantId String

  email    String
  password String
  name     String
  avatar   String?

  // role REMOVIDO - agora usamos apenas customRole.roleType
  customRoleId String
  status       Status @default(ACTIVE)

  lastLoginAt       DateTime?
  resetToken        String?
  resetTokenExpires DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relacionamentos
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customRole    CustomRole     @relation(fields: [customRoleId], references: [id])
  refreshTokens RefreshToken[]
  notifications Notification[]
  deviceTokens  DeviceToken[]

  // Dados criados por este usuario
  createdData EntityData[] @relation("CreatedBy")
  updatedData EntityData[] @relation("UpdatedBy")

  // PDFs solicitados por este usuario
  pdfGenerations PdfGeneration[]

  // Acessos a outros tenants (multi-tenant por usuario)
  tenantAccess UserTenantAccess[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([status])
  @@index([tenantId, status])
  @@index([customRoleId])
  @@index([tenantId, createdAt(sort: Desc)])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String // "android" | "ios" | "web"
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ═══════════════════════════════════════════════════════════════════════════
// ENTITY BUILDER (Entidades Dinamicas)
// ═══════════════════════════════════════════════════════════════════════════

model Entity {
  id       String @id @default(cuid())
  tenantId String

  name        String
  namePlural  String
  slug        String
  description String?
  icon        String?
  color       String?

  fields   Json // [{ slug, name, type, required, options, ... }]
  settings Json    @default("{}")
  isSystem Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  data            EntityData[]
  customEndpoints CustomEndpoint[]
  pdfTemplates    PdfTemplate[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, name])
}

// ═══════════════════════════════════════════════════════════════════════════
// ENTITY DATA (Dados das Entidades)
// ═══════════════════════════════════════════════════════════════════════════

model EntityData {
  id       String @id @default(cuid())
  tenantId String
  entityId String

  data Json

  // Sub-entity support: links child records to a parent record
  parentRecordId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?
  updatedById String?

  // Soft delete for PowerSync sync (tracks deletions for mobile)
  deletedAt DateTime?

  // Trigger-maintained: true if record passes entity's globalFilters
  // Used by PowerSync sync rules to filter at sync time
  matchesGlobalFilter Boolean @default(true) @map("_matchesGlobalFilter")

  // Trigger-maintained: true if parent record passes filters (for sub-entities)
  // Sub-entities only sync if parent also passes
  parentMatchesFilter Boolean @default(true) @map("_parentMatchesFilter")

  // Trigger-maintained: array of CustomRole IDs that can see this record
  // NULL = all roles can see (no role filters configured for this entity)
  // Empty array = no roles can see
  // Array with IDs = only those roles can see
  // PLATFORM_ADMIN and ADMIN always see everything (handled in sync rules)
  visibleToRoles String[] @map("_visibleToRoles")

  // Trigger-maintained: PowerSync-compatible columns derived from _visibleToRoles
  // _hasRoleFilter: true if any role has data filters for this entity
  // _visibleToRolesJson: JSONB array of role IDs (PowerSync IN operator needs JSONB, not TEXT[])
  hasRoleFilter    Boolean @default(false) @map("_hasRoleFilter")
  visibleToRolesJson Json  @default("[]")  @map("_visibleToRolesJson")

  entity       Entity       @relation(fields: [entityId], references: [id], onDelete: Cascade)
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation("CreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy    User?        @relation("UpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  parentRecord EntityData?  @relation("SubRecords", fields: [parentRecordId], references: [id], onDelete: Cascade)
  childRecords EntityData[] @relation("SubRecords")

  @@index([tenantId])
  @@index([entityId])
  @@index([createdAt])
  @@index([createdById])
  @@index([tenantId, entityId])
  @@index([tenantId, entityId, createdAt(sort: Desc)])
  @@index([entityId, createdAt(sort: Desc)])
  @@index([entityId, createdById])
  @@index([parentRecordId])
  @@index([entityId, parentRecordId])
  @@index([updatedById])
  @@index([updatedAt])
  @@index([deletedAt])
}

// ═══════════════════════════════════════════════════════════════════════════
// PAGE BUILDER (Paginas Puck)
// ═══════════════════════════════════════════════════════════════════════════

model Page {
  id       String @id @default(cuid())
  tenantId String

  title       String
  slug        String
  description String?
  icon        String?

  content     Json      @default("{}")
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  permissions Json      @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([isPublished])
  @@index([tenantId, isPublished])
}

// ═══════════════════════════════════════════════════════════════════════════
// API BUILDER (Endpoints Customizados)
// ═══════════════════════════════════════════════════════════════════════════

model CustomEndpoint {
  id       String @id @default(cuid())
  tenantId String

  name        String
  description String?
  path        String
  method      HttpMethod @default(POST)

  mode           String @default("visual")
  requestSchema  Json?
  responseSchema Json?

  sourceEntityId String?
  sourceEntity   Entity? @relation(fields: [sourceEntityId], references: [id], onDelete: SetNull)

  selectedFields Json   @default("[]")
  filters        Json   @default("[]")
  queryParams    Json   @default("[]")
  orderBy        Json?
  limitRecords   Int?
  responseType   String @default("records") // "records" | "count" | "computed"
  computedValues Json   @default("[]") // Para responseType "computed": [{ field, template }]

  logic       Json     @default("[]")
  auth        AuthType @default(JWT)
  permissions Json     @default("[]")
  rateLimit   Int      @default(100)
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, path, method])
  @@index([tenantId])
  @@index([isActive])
  @@index([sourceEntityId])
  @@index([tenantId, isActive])
}

// ═══════════════════════════════════════════════════════════════════════════
// AUDIT LOG
// ═══════════════════════════════════════════════════════════════════════════

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String?
  action     String
  resource   String
  resourceId String?
  oldData    Json?
  newData    Json?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, action])
  @@index([tenantId, resource])
  @@index([tenantId, userId])
  @@index([resource, resourceId])
  @@index([tenantId, action, resource])
}

// ═══════════════════════════════════════════════════════════════════════════
// NOTIFICATIONS
// ═══════════════════════════════════════════════════════════════════════════

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

model Notification {
  id         String           @id @default(cuid())
  tenantId   String
  userId     String
  type       NotificationType @default(INFO)
  title      String
  message    String
  data       Json?
  entitySlug String?
  read       Boolean          @default(false)
  readAt     DateTime?
  createdAt  DateTime         @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([userId, read])
  @@index([userId, createdAt(sort: Desc)])
  @@index([tenantId, userId])
  @@index([entitySlug])
}

// ═══════════════════════════════════════════════════════════════════════════
// CUSTOM ROLES (Papeis customizaveis por tenant)
// ═══════════════════════════════════════════════════════════════════════════

model CustomRole {
  id          String  @id @default(cuid())
  tenantId    String
  name        String
  description String?
  color       String? @default("#6366f1")

  // Tipo da role: PLATFORM_ADMIN, ADMIN, MANAGER, USER, VIEWER, CUSTOM
  roleType String @default("CUSTOM")

  // Marca roles pre-configuradas do sistema (nome e roleType protegidos)
  isSystem Boolean @default(false)

  // JSON array de permissoes por entidade
  // Formato: [{ "entitySlug": "clientes", "canCreate": true, "canRead": true, "canUpdate": true, "canDelete": false, "scope": "all"|"own" }]
  permissions Json @default("[]")

  // Permissoes globais (modulos do sistema)
  // Formato: { "dashboard": true, "users": false, "settings": false, "apis": false, "pages": false, "entities": false }
  modulePermissions Json @default("{}")

  // Permissoes de tenant (apenas para PLATFORM_ADMIN)
  // Formato: { "canAccessAllTenants": true, "allowedTenantIds": [] }
  tenantPermissions Json @default("{}")

  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users  User[]
  tenantAccessUsers UserTenantAccess[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isSystem])
  @@index([roleType])
  @@index([tenantId, isDefault])
  @@index([tenantId, roleType])
}

// ═══════════════════════════════════════════════════════════════════════════
// USER TENANT ACCESS (Acesso multi-tenant por usuario)
// ═══════════════════════════════════════════════════════════════════════════

model UserTenantAccess {
  id           String    @id @default(cuid())
  userId       String
  tenantId     String
  customRoleId String
  status       Status    @default(ACTIVE)
  grantedAt    DateTime  @default(now())
  expiresAt    DateTime?
  grantedById  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customRole CustomRole @relation(fields: [customRoleId], references: [id])

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
  @@index([customRoleId])
}

// ═══════════════════════════════════════════════════════════════════════════
// PDF TEMPLATES (Templates de PDF customizaveis)
// ═══════════════════════════════════════════════════════════════════════════

model PdfTemplate {
  id       String @id @default(cuid())
  tenantId String

  name        String
  slug        String
  description String?
  icon        String?

  // Configuracoes de pagina
  pageSize    PdfPageSize    @default(A4)
  orientation PdfOrientation @default(PORTRAIT)
  margins     Json           @default("{\"top\":70,\"right\":70,\"bottom\":70,\"left\":70}")

  // Conteudo do template (estrutura JSON do editor visual)
  // Formato: { header: {...}, body: [...], footer: {...} }
  content Json @default("{}")

  // Entidade fonte de dados principal
  sourceEntityId String?
  sourceEntity   Entity? @relation(fields: [sourceEntityId], references: [id], onDelete: SetNull)

  // Campos selecionados da entidade
  selectedFields Json @default("[]")

  // Logo padrao do template
  logoUrl String?

  // Tipo de template: "single" (1 registro) ou "batch" (multiplos)
  templateType String @default("single")

  // Controle de versao e publicacao
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  version     Int       @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  generations PdfGeneration[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([sourceEntityId])
  @@index([isPublished])
  @@index([tenantId, isPublished])
}

// ═══════════════════════════════════════════════════════════════════════════
// PDF GENERATION (Historico de PDFs gerados)
// ═══════════════════════════════════════════════════════════════════════════

model PdfGeneration {
  id         String @id @default(cuid())
  tenantId   String
  templateId String

  // Status e progresso
  status   PdfGenerationStatus @default(PENDING)
  progress Int                 @default(0) // 0-100

  // IDs dos registros fonte
  recordIds Json @default("[]")

  // Resultado
  fileUrl   String?
  fileName  String?
  fileSize  Int?
  pageCount Int?

  // Erro (se houver)
  errorMessage String?

  // Metadados adicionais
  metadata Json?

  // Quem solicitou
  requestedById String?
  requestedBy   User?   @relation(fields: [requestedById], references: [id], onDelete: SetNull)

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  // Relacionamentos
  tenant   Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template PdfTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([templateId])
  @@index([status])
  @@index([requestedById])
  @@index([createdAt])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, status])
}

