// CRM BUILDER - Database Schema
// PostgreSQL 16 + Prisma 5.x

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum Plan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum Status {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum UserRole {
  PLATFORM_ADMIN // Super admin da plataforma
  ADMIN          // Admin do tenant
  MANAGER        // Gerente
  USER           // Usuario padrao
  VIEWER         // Apenas visualizacao
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
}

enum AuthType {
  NONE
  JWT
  API_KEY
}

// ═══════════════════════════════════════════════════════════════════════════
// TENANT (Empresa)
// ═══════════════════════════════════════════════════════════════════════════

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  domain    String?  @unique
  logo      String?
  settings  Json     @default("{}")

  plan      Plan     @default(FREE)
  status    Status   @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  users           User[]
  roles           Role[]
  entities        Entity[]
  entityData      EntityData[]
  pages           Page[]
  customEndpoints CustomEndpoint[]

  @@index([slug])
  @@index([status])
  @@index([plan])
}

// ═══════════════════════════════════════════════════════════════════════════
// USERS
// ═══════════════════════════════════════════════════════════════════════════

model User {
  id        String    @id @default(cuid())
  tenantId  String

  email     String
  password  String
  name      String
  avatar    String?

  role      UserRole  @default(USER)
  status    Status    @default(ACTIVE)

  lastLoginAt       DateTime?
  resetToken        String?
  resetTokenExpires DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relacionamentos
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles     UserRole_[]
  refreshTokens RefreshToken[]

  // Dados criados por este usuario
  createdData EntityData[] @relation("CreatedBy")
  updatedData EntityData[] @relation("UpdatedBy")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, role])
  @@index([tenantId, createdAt(sort: Desc)])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ═══════════════════════════════════════════════════════════════════════════
// ROLES & PERMISSIONS (RBAC)
// ═══════════════════════════════════════════════════════════════════════════

model Role {
  id          String   @id @default(cuid())
  tenantId    String

  name        String
  slug        String
  description String?

  permissions Json    @default("[]")
  isSystem    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users  UserRole_[]

  @@unique([tenantId, slug])
  @@index([tenantId])
}

model UserRole_ {
  id     String @id @default(cuid())
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// ═══════════════════════════════════════════════════════════════════════════
// ENTITY BUILDER (Entidades Dinamicas)
// ═══════════════════════════════════════════════════════════════════════════

model Entity {
  id       String @id @default(cuid())
  tenantId String

  name        String
  namePlural  String
  slug        String
  description String?
  icon        String?
  color       String?

  fields   Json    // [{ slug, name, type, required, options, ... }]
  settings Json    @default("{}")
  isSystem Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  data            EntityData[]
  customEndpoints CustomEndpoint[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, name])
}

// ═══════════════════════════════════════════════════════════════════════════
// ENTITY DATA (Dados das Entidades)
// ═══════════════════════════════════════════════════════════════════════════

model EntityData {
  id       String @id @default(cuid())
  tenantId String
  entityId String

  data Json

  // Sub-entity support: links child records to a parent record
  parentRecordId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?
  updatedById String?

  entity       Entity      @relation(fields: [entityId], references: [id], onDelete: Cascade)
  tenant       Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy    User?       @relation("CreatedBy", fields: [createdById], references: [id])
  updatedBy    User?       @relation("UpdatedBy", fields: [updatedById], references: [id])
  parentRecord EntityData? @relation("SubRecords", fields: [parentRecordId], references: [id], onDelete: Cascade)
  childRecords EntityData[] @relation("SubRecords")

  @@index([tenantId])
  @@index([entityId])
  @@index([createdAt])
  @@index([createdById])
  @@index([tenantId, entityId])
  @@index([tenantId, entityId, createdAt(sort: Desc)])
  @@index([entityId, createdAt(sort: Desc)])
  @@index([entityId, createdById])
  @@index([parentRecordId])
  @@index([entityId, parentRecordId])
}

// ═══════════════════════════════════════════════════════════════════════════
// PAGE BUILDER (Paginas Puck)
// ═══════════════════════════════════════════════════════════════════════════

model Page {
  id       String @id @default(cuid())
  tenantId String

  title       String
  slug        String
  description String?
  icon        String?

  content     Json    @default("{}")
  isPublished Boolean @default(false)
  publishedAt DateTime?
  permissions Json    @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([isPublished])
  @@index([tenantId, isPublished])
}

// ═══════════════════════════════════════════════════════════════════════════
// API BUILDER (Endpoints Customizados)
// ═══════════════════════════════════════════════════════════════════════════

model CustomEndpoint {
  id       String     @id @default(cuid())
  tenantId String

  name        String
  description String?
  path        String
  method      HttpMethod @default(POST)

  mode           String  @default("visual")
  requestSchema  Json?
  responseSchema Json?

  sourceEntityId String?
  sourceEntity   Entity? @relation(fields: [sourceEntityId], references: [id], onDelete: SetNull)

  selectedFields Json @default("[]")
  filters        Json @default("[]")
  queryParams    Json @default("[]")
  orderBy        Json?
  limitRecords   Int?

  logic       Json     @default("[]")
  auth        AuthType @default(JWT)
  permissions Json     @default("[]")
  rateLimit   Int      @default(100)
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, path, method])
  @@index([tenantId])
  @@index([isActive])
  @@index([sourceEntityId])
  @@index([tenantId, isActive])
}

// ═══════════════════════════════════════════════════════════════════════════
// AUDIT LOG
// ═══════════════════════════════════════════════════════════════════════════

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String?
  action     String
  resource   String
  resourceId String?
  oldData    Json?
  newData    Json?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, action])
  @@index([tenantId, resource])
  @@index([tenantId, userId])
  @@index([resource, resourceId])
}

// ═══════════════════════════════════════════════════════════════════════════
// NOTIFICATIONS
// ═══════════════════════════════════════════════════════════════════════════

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

model Notification {
  id        String           @id @default(cuid())
  tenantId  String
  userId    String
  type      NotificationType @default(INFO)
  title     String
  message   String
  data      Json?
  read      Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([userId, read])
  @@index([userId, createdAt(sort: Desc)])
  @@index([tenantId, userId])
}
