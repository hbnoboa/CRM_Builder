// CRM BUILDER - Database Schema
// PostgreSQL 16 + Prisma 5.x

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════════════════

enum Status {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// UserRole enum REMOVIDO - agora usamos CustomRole.roleType
// Tipos validos: PLATFORM_ADMIN, ADMIN, MANAGER, USER, VIEWER, CUSTOM

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
}

enum AuthType {
  NONE
  JWT
  API_KEY
}

// ═══════════════════════════════════════════════════════════════════════════
// TENANT (Empresa)
// ═══════════════════════════════════════════════════════════════════════════

model Tenant {
  id       String  @id @default(cuid())
  name     String
  slug     String  @unique
  domain   String? @unique
  logo     String?
  settings Json    @default("{}")

  status Status @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  users           User[]
  entities        Entity[]
  entityData      EntityData[]
  pages           Page[]
  customEndpoints CustomEndpoint[]
  customRoles     CustomRole[]
  notifications   Notification[]
  pdfTemplates    PdfTemplate[]
  pdfGenerations  PdfGeneration[]

  @@index([slug])
  @@index([status])
}

// ═══════════════════════════════════════════════════════════════════════════
// USERS
// ═══════════════════════════════════════════════════════════════════════════

model User {
  id       String @id @default(cuid())
  tenantId String

  email    String
  password String
  name     String
  avatar   String?

  // role REMOVIDO - agora usamos apenas customRole.roleType
  customRoleId String
  status       Status @default(ACTIVE)

  lastLoginAt       DateTime?
  resetToken        String?
  resetTokenExpires DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relacionamentos
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customRole    CustomRole     @relation(fields: [customRoleId], references: [id])
  refreshTokens RefreshToken[]
  notifications Notification[]
  deviceTokens  DeviceToken[]

  // Dados criados por este usuario
  createdData EntityData[] @relation("CreatedBy")
  updatedData EntityData[] @relation("UpdatedBy")

  // PDFs criados por este usuario
  pdfTemplatesCreated   PdfTemplate[]   @relation("PdfTemplatesCreated")
  pdfGenerationsCreated PdfGeneration[] @relation("PdfGenerationsCreated")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([status])
  @@index([tenantId, status])
  @@index([customRoleId])
  @@index([tenantId, createdAt(sort: Desc)])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String // "android" | "ios" | "web"
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ═══════════════════════════════════════════════════════════════════════════
// ENTITY BUILDER (Entidades Dinamicas)
// ═══════════════════════════════════════════════════════════════════════════

model Entity {
  id       String @id @default(cuid())
  tenantId String

  name        String
  namePlural  String
  slug        String
  description String?
  icon        String?
  color       String?

  fields   Json // [{ slug, name, type, required, options, ... }]
  settings Json    @default("{}")
  isSystem Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  data            EntityData[]
  customEndpoints CustomEndpoint[]
  pdfTemplates    PdfTemplate[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, name])
}

// ═══════════════════════════════════════════════════════════════════════════
// ENTITY DATA (Dados das Entidades)
// ═══════════════════════════════════════════════════════════════════════════

model EntityData {
  id       String @id @default(cuid())
  tenantId String
  entityId String

  data Json

  // Sub-entity support: links child records to a parent record
  parentRecordId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?
  updatedById String?

  // Soft delete for PowerSync sync (tracks deletions for mobile)
  deletedAt DateTime?

  // Trigger-maintained: true if record passes entity's globalFilters
  // Used by PowerSync sync rules to filter at sync time
  matchesGlobalFilter Boolean @default(true) @map("_matchesGlobalFilter")

  // Trigger-maintained: true if parent record passes filters (for sub-entities)
  // Sub-entities only sync if parent also passes
  parentMatchesFilter Boolean @default(true) @map("_parentMatchesFilter")

  entity       Entity       @relation(fields: [entityId], references: [id], onDelete: Cascade)
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation("CreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy    User?        @relation("UpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  parentRecord EntityData?  @relation("SubRecords", fields: [parentRecordId], references: [id], onDelete: Cascade)
  childRecords EntityData[] @relation("SubRecords")

  @@index([tenantId])
  @@index([entityId])
  @@index([createdAt])
  @@index([createdById])
  @@index([tenantId, entityId])
  @@index([tenantId, entityId, createdAt(sort: Desc)])
  @@index([entityId, createdAt(sort: Desc)])
  @@index([entityId, createdById])
  @@index([parentRecordId])
  @@index([entityId, parentRecordId])
  @@index([updatedById])
  @@index([updatedAt])
  @@index([deletedAt])
}

// ═══════════════════════════════════════════════════════════════════════════
// PAGE BUILDER (Paginas Puck)
// ═══════════════════════════════════════════════════════════════════════════

model Page {
  id       String @id @default(cuid())
  tenantId String

  title       String
  slug        String
  description String?
  icon        String?

  content     Json      @default("{}")
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  permissions Json      @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([isPublished])
  @@index([tenantId, isPublished])
}

// ═══════════════════════════════════════════════════════════════════════════
// API BUILDER (Endpoints Customizados)
// ═══════════════════════════════════════════════════════════════════════════

model CustomEndpoint {
  id       String @id @default(cuid())
  tenantId String

  name        String
  description String?
  path        String
  method      HttpMethod @default(POST)

  mode           String @default("visual")
  requestSchema  Json?
  responseSchema Json?

  sourceEntityId String?
  sourceEntity   Entity? @relation(fields: [sourceEntityId], references: [id], onDelete: SetNull)

  selectedFields Json   @default("[]")
  filters        Json   @default("[]")
  queryParams    Json   @default("[]")
  orderBy        Json?
  limitRecords   Int?
  responseType   String @default("records") // "records" | "count"

  logic       Json     @default("[]")
  auth        AuthType @default(JWT)
  permissions Json     @default("[]")
  rateLimit   Int      @default(100)
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, path, method])
  @@index([tenantId])
  @@index([isActive])
  @@index([sourceEntityId])
  @@index([tenantId, isActive])
}

// ═══════════════════════════════════════════════════════════════════════════
// AUDIT LOG
// ═══════════════════════════════════════════════════════════════════════════

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String?
  action     String
  resource   String
  resourceId String?
  oldData    Json?
  newData    Json?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, action])
  @@index([tenantId, resource])
  @@index([tenantId, userId])
  @@index([resource, resourceId])
  @@index([tenantId, action, resource])
}

// ═══════════════════════════════════════════════════════════════════════════
// NOTIFICATIONS
// ═══════════════════════════════════════════════════════════════════════════

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

model Notification {
  id         String           @id @default(cuid())
  tenantId   String
  userId     String
  type       NotificationType @default(INFO)
  title      String
  message    String
  data       Json?
  entitySlug String?
  read       Boolean          @default(false)
  readAt     DateTime?
  createdAt  DateTime         @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([userId, read])
  @@index([userId, createdAt(sort: Desc)])
  @@index([tenantId, userId])
  @@index([entitySlug])
}

// ═══════════════════════════════════════════════════════════════════════════
// CUSTOM ROLES (Papeis customizaveis por tenant)
// ═══════════════════════════════════════════════════════════════════════════

model CustomRole {
  id          String  @id @default(cuid())
  tenantId    String
  name        String
  description String?
  color       String? @default("#6366f1")

  // Tipo da role: PLATFORM_ADMIN, ADMIN, MANAGER, USER, VIEWER, CUSTOM
  roleType String @default("CUSTOM")

  // Marca roles pre-configuradas do sistema (nome e roleType protegidos)
  isSystem Boolean @default(false)

  // JSON array de permissoes por entidade
  // Formato: [{ "entitySlug": "clientes", "canCreate": true, "canRead": true, "canUpdate": true, "canDelete": false, "scope": "all"|"own" }]
  permissions Json @default("[]")

  // Permissoes globais (modulos do sistema)
  // Formato: { "dashboard": true, "users": false, "settings": false, "apis": false, "pages": false, "entities": false }
  modulePermissions Json @default("{}")

  // Permissoes de tenant (apenas para PLATFORM_ADMIN)
  // Formato: { "canAccessAllTenants": true, "allowedTenantIds": [] }
  tenantPermissions Json @default("{}")

  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users  User[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isSystem])
  @@index([roleType])
  @@index([tenantId, isDefault])
  @@index([tenantId, roleType])
}

// ═══════════════════════════════════════════════════════════════════════════
// PDF TEMPLATES (Gerador de PDF)
// ═══════════════════════════════════════════════════════════════════════════

model PdfTemplate {
  id       String @id @default(cuid())
  tenantId String

  name        String
  slug        String
  description String?
  icon        String?
  category    String? // "relatorio", "ficha", "etiqueta", etc

  // Tipo do template
  isSystem Boolean @default(false) // Templates padrao (nao podem ser deletados)
  isGlobal Boolean @default(false) // Disponivel para todos tenants (PLATFORM_ADMIN)

  // Entidade associada (dados vem dela)
  entityId   String?
  entitySlug String?

  // Conteudo do template (JSON schema)
  // basePdf: { width, height, padding }
  basePdf Json @default("{}")

  // schemas: Array de elementos posicionados por pagina
  // [{ name, type, position, width, height, fieldSlug, staticValue, expression, format, condition, ... }]
  schemas Json @default("[]")

  // Configuracoes
  // { pageSize, orientation, margins, headerHeight, footerHeight, ... }
  settings Json @default("{}")

  // Workflow
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  version     Int       @default(1)

  // Clonagem
  clonedFromId String? // Se foi clonado de outro template

  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?

  // Relacionamentos
  tenant     Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  entity     Entity?       @relation(fields: [entityId], references: [id])
  createdBy  User?         @relation("PdfTemplatesCreated", fields: [createdById], references: [id], onDelete: SetNull)
  clonedFrom PdfTemplate?  @relation("TemplateClones", fields: [clonedFromId], references: [id], onDelete: SetNull)
  clones     PdfTemplate[] @relation("TemplateClones")

  generations PdfGeneration[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, entitySlug])
  @@index([isPublished])
  @@index([isSystem])
  @@index([isGlobal])
  @@index([category])
  @@index([createdById])
}

// ═══════════════════════════════════════════════════════════════════════════
// PDF GENERATIONS (Historico de Geracoes)
// ═══════════════════════════════════════════════════════════════════════════

model PdfGeneration {
  id         String @id @default(cuid())
  tenantId   String
  templateId String

  // Dados usados na geracao
  recordId  String? // ID do registro da entidade
  inputData Json    @default("{}")

  // Resultado
  status    String  @default("pending") // pending, processing, completed, failed
  fileUrl   String?
  fileSize  Int?
  pageCount Int?
  error     String?

  // Timestamps
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime? // Para cleanup automatico

  // Relacoes
  createdById String?

  tenant    Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template  PdfTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  createdBy User?       @relation("PdfGenerationsCreated", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([templateId])
  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([tenantId, status])
  @@index([tenantId, templateId])
}
