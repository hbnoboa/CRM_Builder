# PowerSync self-hosted service for CRM Builder mobile app.
# Provides real-time sync between PostgreSQL and Flutter (SQLite).
#
# Usage:
#   docker compose -f docker-compose.powersync.yml --env-file .env.production up -d
#
# Prerequisites:
#   - PostgreSQL must have wal_level=logical enabled
#   - JWT_SECRET must match the NestJS API JWT secret

services:
  powersync-mongo:
    image: mongo:7
    container_name: crm-powersync-mongo
    restart: unless-stopped
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    volumes:
      - powersync-mongo-data:/data/db
    networks:
      - crm-network

  powersync:
    image: journeyapps/powersync-service:latest
    container_name: crm-powersync
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      PS_REPLICATION_URI: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-crm_builder}?sslmode=disable
      PS_MONGO_URI: mongodb://powersync-mongo:27017/powersync?replicaSet=rs0
      PS_JWT_SECRET_B64: Q3JtQnVpbGRlcjIwMjZTdXBlclNlY3JldEtleUZvckpXVFRva2VuR2VuZXJhdGlvblBsZWFzZUNoYW5nZUluUHJvZHVjdGlvbjY0Y2hhcnM
      PS_API_TOKEN: powersync-crm-admin-token
    volumes:
      - ./apps/mobile/powersync.yaml:/app/powersync.yaml:ro
    depends_on:
      - powersync-mongo
    networks:
      - crm-network

volumes:
  powersync-mongo-data:

networks:
  crm-network:
    external: true
    name: crm-builder_crm-network
